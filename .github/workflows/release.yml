name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Scoop manifest
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHA256=$(grep "zenodo_${VERSION}_windows_amd64.zip" dist/checksums.txt | awk '{print $1}')

          jq \
            --arg ver "$VERSION" \
            --arg hash "$SHA256" \
            '.version = $ver | .architecture."64bit".url = "https://github.com/ran-codes/zenodo-cli/releases/download/v\($ver)/zenodo_\($ver)_windows_amd64.zip" | .architecture."64bit".hash = $hash' \
            bucket/zenodo.json > bucket/zenodo.json.tmp

          mv bucket/zenodo.json.tmp bucket/zenodo.json

      - name: Commit updated Scoop manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git add bucket/zenodo.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "scoop: update manifest to v${GITHUB_REF_NAME#v}"
          git push origin main
